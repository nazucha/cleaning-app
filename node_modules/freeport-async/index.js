const net = require("net");

const DEFAULT_PORT_RANGE_START = 11000;

function testPortAsync(port, hostname) {
  return new Promise(function(fulfill, reject) {
    var server = net.createServer();
    server.listen({ port: port, host: hostname }, function(err) {
      server.once("close", function() {
        setTimeout(() => fulfill(true), 0);
      });
      server.close();
    });
    server.on("error", function(err) {
      setTimeout(() => fulfill(false), 0);
    });
  });
}

async function availableAsync(port, options = {}) {
  const hostnames =
    options.hostnames && options.hostnames.length ? options.hostnames : [null];
  for (const hostname of hostnames) {
    if (!(await testPortAsync(port, hostname))) {
      return false;
    }
  }
  return true;
}

function freePortRangeAsync(rangeSize, rangeStart, options = {}) {
  rangeSize = rangeSize || 1;
  return new Promise((fulfill, reject) => {
    var lowPort = rangeStart || DEFAULT_PORT_RANGE_START;
    // ポート番号の最大値は65535
    if (lowPort >= 65535) {
      return reject(new Error('Port range exceeded maximum (65535)'));
    }
    // 範囲が65535を超えないように調整
    if (lowPort + rangeSize > 65535) {
      rangeSize = 65535 - lowPort;
    }
    var awaitables = [];
    for (var i = 0; i < rangeSize; i++) {
      awaitables.push(availableAsync(lowPort + i, options));
    }
    return Promise.all(awaitables).then(function(results) {
      var ports = [];
      for (var i = 0; i < results.length; i++) {
        if (!results[i]) {
          var nextPort = lowPort + rangeSize;
          // 次のポートが65535を超える場合はエラー
          if (nextPort >= 65535) {
            return reject(new Error('No available ports in range'));
          }
          return freePortRangeAsync(
            rangeSize,
            nextPort,
            options
          ).then(fulfill, reject);
        }
        ports.push(lowPort + i);
      }
      fulfill(ports);
    });
  });
}

async function freePortAsync(rangeStart, options = {}) {
  const result = await freePortRangeAsync(1, rangeStart, options);
  return result[0];
}

module.exports = freePortAsync;

module.exports.availableAsync = availableAsync;
module.exports.rangeAsync = freePortRangeAsync;
