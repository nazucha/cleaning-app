# 共有Googleカレンダーの設定方法

## ✅ はい、共有カレンダーに対応しています！

共有されたGoogleカレンダーを見て空き状況を確認できます。

## 共有カレンダーの設定手順

### 1. カレンダーIDの取得方法

共有カレンダーのIDを取得するには、以下の方法があります：

#### 方法A: Googleカレンダーの設定から取得

1. [Googleカレンダー](https://calendar.google.com/) にアクセス
2. 左側のカレンダー一覧で、共有したいカレンダーの横にある「⋮」（三点メニュー）をクリック
3. 「設定と共有」を選択
4. 「カレンダーの統合」セクションまでスクロール
5. 「カレンダーID」をコピー
   - 形式: `example@gmail.com` または `カレンダー名`
   - 例: `cleaning-service@group.calendar.google.com`

#### 方法B: カレンダーの共有設定から確認

1. カレンダーの「設定と共有」を開く
2. 「特定のユーザーと共有」セクションで、Composioで使用しているGoogleアカウントに「予定の確認」以上の権限を付与
3. カレンダーIDをコピー

### 2. カレンダーIDの設定方法

#### オプションA: 環境変数で設定（推奨）

`.env` ファイルを作成（または既存のファイルに追加）：

```bash
CALENDAR_ID=your-calendar-id@gmail.com
```

サーバー起動時に自動的に読み込まれます。

#### オプションB: server.jsで直接設定

`server.js` の以下の行を編集：

```javascript
const CALENDAR_ID = process.env.CALENDAR_ID || "your-calendar-id@gmail.com";
```

#### オプションC: 複数のカレンダーをチェック

複数のカレンダーをチェックする場合、`server.js` を修正して複数のカレンダーIDを配列で指定できます。

### 3. カレンダーの共有権限

Composioで使用しているGoogleアカウントに、以下の権限が必要です：

- **最低限**: 「予定の確認」（読み取り専用）
- **推奨**: 「予定の変更」（読み書き可能、予定の追加も可能）

### 4. Composioでの設定確認

1. [Composio Dashboard](https://app.composio.dev/) にログイン
2. 「Apps」→「Google Calendar」を確認
3. 接続されているGoogleアカウントが、共有カレンダーへのアクセス権限を持っているか確認

## 動作確認

### テスト方法

1. 共有カレンダーにテスト予定を追加
2. フォームでその日時を選択
3. 「スタッフが随時対応」と表示されることを確認
4. 予定を削除
5. 再度同じ日時を選択
6. 「確定」と表示されることを確認

### トラブルシューティング

#### カレンダーが見つからない

- カレンダーIDが正しいか確認
- Composioで使用しているGoogleアカウントに共有権限があるか確認
- カレンダーが削除されていないか確認

#### 常に「スタッフが随時対応」と表示される

- カレンダーに予定が入っている可能性
- カレンダーIDが間違っている可能性
- 共有権限が不足している可能性

#### エラーが発生する

- ブラウザのコンソールでエラーを確認
- バックエンドサーバーのログを確認
- Composioの接続状態を確認

## 複数のカレンダーをチェックする場合

複数のカレンダー（例：複数のスタッフのカレンダー）をチェックする場合、`server.js` を以下のように修正できます：

```javascript
// 複数のカレンダーIDを配列で指定
const CALENDAR_IDS = [
  "staff1@gmail.com",
  "staff2@gmail.com",
  "shared-calendar@group.calendar.google.com"
];

// すべてのカレンダーが空いているかチェック
const allAvailable = await Promise.all(
  CALENDAR_IDS.map(calId => 
    toolSet.executeAction({
      action: "GOOGLECALENDAR_CALENDARS_FREEBUSY_QUERY",
      params: {
        calendarId: calId,
        timeMin: dateTime.toISOString(),
        timeMax: endDateTime.toISOString(),
      },
      entityId: "default",
    })
  )
);

// すべてのカレンダーが空いている場合のみ「確定」
const isAvailable = allAvailable.every(response => 
  !response.calendars || 
  Object.values(response.calendars).every(cal => 
    !cal.busy || cal.busy.length === 0
  )
);
```

## 注意事項

- 共有カレンダーのIDは、通常のメールアドレス形式（`example@gmail.com`）またはグループカレンダー形式（`group@group.calendar.google.com`）です
- カレンダー名（日本語など）は使用できません。必ずカレンダーIDを使用してください
- カレンダーIDは大文字小文字を区別します

## 次のステップ

1. 共有カレンダーのIDを取得
2. `server.js` または環境変数でカレンダーIDを設定
3. サーバーを再起動
4. フォームで動作確認
